# 开发环境配置

## 开发环境和工具
- Ubuntu 20.04.3 LTS
- vscode
- NASM (version 2.14.02)
- bochs (Bochs x86 Emulator 2.6.11)

安装命令
```
sudo apt-get install nasm
sudo apt-get install bochs
sudo apt-get install bochs-x
```

## boot.asm
| 语法命令      | 描述 |
| ----------- | ----------- |
| org      | 规定程序的起始地址       |
| $   | 表示当前行被汇编后的地址        |
|$$|表示一个节的开始处被汇编后的地址|

编译

`nasm -f bin boot.asm -o boot.bin`

## 创建硬盘镜像
bxiamge --help 查看不同版本的命令解释

`bximage -q -hd=16 -mode=create -sectsize=512 -imgmode=flat master.img`

拷贝生成的参数到下面的的 bochs 文件中

将 boot.bin 写入主引导扇区(不做截断)

`dd if=boot.bin of=master.img bs=512 count=1 conv=notrunc`

## 配置 bochs
```
bochs -q
选择 4 保存配置文件
输入配置文件名称:bochsrc
选择 7 退出
```
拷贝生成的参数，到下面的 bochsrc 中

ata0-master: type=disk, path="master.img", mode=flat

修改 bochsrc
开启 gui 调试。启动方式为硬盘
```
display_library: x, options="gui_debug"
ata0-master: type=disk, path="master.img", mode=flat
boot: disk
```

## 启动
bochs -f bochsrc
```ini
# configuration file generated by Bochs
plugin_ctrl: unmapped=true, biosdev=true, speaker=true, extfpuirq=true, parallel=true, serial=true, gameport=true, iodebug=true
config_interface: textconfig
display_library: x, options="gui_debug"
memory: host=32, guest=32
romimage: file="/usr/share/bochs/BIOS-bochs-latest", address=0x00000000, options=none
vgaromimage: file="/usr/share/bochs/VGABIOS-lgpl-latest"
boot: disk
floppy_bootsig_check: disabled=0
# no floppya
# no floppyb
ata0: enabled=true, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
ata0-master: type=disk, path="master.img", mode=flat
ata0-slave: type=none
ata1: enabled=true, ioaddr1=0x170, ioaddr2=0x370, irq=15
ata1-master: type=none
ata1-slave: type=none
ata2: enabled=false
ata3: enabled=false
optromimage1: file=none
optromimage2: file=none
optromimage3: file=none
optromimage4: file=none
optramimage1: file=none
optramimage2: file=none
optramimage3: file=none
optramimage4: file=none
pci: enabled=1, chipset=i440fx
vga: extension=vbe, update_freq=5, realtime=1
cpu: count=1:1:1, ips=4000000, quantum=16, model=bx_generic, reset_on_triple_fault=1, cpuid_limit_winnt=0, ignore_bad_msrs=1, mwait_is_nop=0
cpuid: level=6, stepping=3, model=3, family=6, vendor_string="GenuineIntel", brand_string="              Intel(R) Pentium(R) 4 CPU        "
cpuid: mmx=true, apic=xapic, simd=sse2, sse4a=false, misaligned_sse=false, sep=true
cpuid: movbe=false, adx=false, aes=false, sha=false, xsave=false, xsaveopt=false, avx_f16c=false
cpuid: avx_fma=false, bmi=0, xop=false, fma4=false, tbm=false, x86_64=true, 1g_pages=false
cpuid: pcid=false, fsgsbase=false, smep=false, smap=false, mwait=true, vmx=1, svm=false
print_timestamps: enabled=0
debugger_log: -
magic_break: enabled=0
port_e9_hack: enabled=0
private_colormap: enabled=0
clock: sync=none, time0=local, rtc_sync=0
# no cmosimage
log: -
logprefix: %t%e%d
debug: action=ignore
info: action=report
error: action=report
panic: action=ask
keyboard: type=mf, serial_delay=250, paste_delay=100000, user_shortcut=none
mouse: type=ps2, enabled=false, toggle=ctrl+mbutton
sound: waveoutdrv=alsa, waveout=none, waveindrv=alsa, wavein=none, midioutdrv=alsa, midiout=none
speaker: enabled=true, mode=sound
parport1: enabled=true, file=none
parport2: enabled=false
com1: enabled=true, mode=null
com2: enabled=false
com3: enabled=false
com4: enabled=false

```